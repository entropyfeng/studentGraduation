<title>部门信息</title>

<div class="layui-card layadmin-header">
    <div class="layui-breadcrumb" lay-filter="breadcrumb">
        <a lay-href="">主页</a>
        <a><cite>部门信息</cite></a>
    </div>
</div>

<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-form layui-card-header layuiadmin-card-header-auto"
             lay-filter="graduation-departmentInformation-formlist">


            <div class="layui-card-body">
                <div style="padding-bottom: 10px;">
                    <button class="layui-btn department" data-type="batchdel">删除</button>
                    <button class="layui-btn department" data-type="add">添加</button>
                </div>

                <table id="department-information" lay-filter="department-information"></table>

                <script type="text/html" id="department-information-bar">
                    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"><i
                            class="layui-icon layui-icon-edit"></i>编辑</a>
                    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i
                            class="layui-icon layui-icon-delete"></i>删除</a>
                </script>
            </div>
        </div>
    </div>
</div>
<script>


    layui.define(['table', 'form'], function (exports) {
        var $ = layui.$
            , admin = layui.admin
            , view = layui.view
            , table = layui.table
            , form = layui.form
            , setter = layui.setter
            , true_url = layui.setter.true_url
            , jwt = layui.data(setter.tableName)['jwt'];

        table.render({
            elem: '#department-information'
            , url: true_url + '/departmentInformation/get' //向服务器请求接口
            , method: 'get'
            , headers: {
                "jwt": jwt
            }
            , parseData: function (res) {
                var meta = res['meta'];
                var data = res['data'];
                return {
                    "code": 0
                    , "data": data['departments']
                    , "msg": meta['msg']
                    , "count": data['count']

                }
            }
            , cols: [[
                {type: 'checkbox', fixed: 'left'}
                , {field: 'departmentId', width: 100, title: 'ID', sort: true}
                , {field: 'departmentName', title: '部门名称', minWidth: 100}
                , {field: 'departmentDescription', title: '部门描述'}
                , {title: '操作', width: 150, align: 'center', fixed: 'right', toolbar: '#department-information-bar'}
            ]]
            , page: true
            , limit: 30
            , height: 'full-320'
            , text: '对不起，加载出现异常！'
        });

        //监听工具条
        table.on('tool(department-information)', function (obj) {
            var data = obj.data;
            if (obj.event === 'del') {
                layer.alert('确认删除', {

                        btn: ['确认', '取消']
                        , btn1: function () {
                            admin.req({
                                method:'delete'
                                ,url: true_url + '/departmentInformation/delete'+"?departmentId="+data.departmentId
                                , success: function (res) {
                                    var meta = res['meta'];
                                    layer.msg(meta['msg']);
                                    layui.table.reload('department-information'); //重载表格
                                }
                                , error: function (res) {
                                    layer.msg('未知错误');

                                }

                            });

                        }
                        , btn2: function () {
                            layer.msg('已取消');
                        }
                    }
                );
            } else if (obj.event === 'edit') {
                admin.popup({
                    title: '编辑部门'
                    , area: ['500px', '450px']
                    , id: 'LAY-popup-department-add'
                    , success: function (layero, index) {
                        view(this.id).render('departments/edit-department-form', data).done(function () {
                            form.on('submit(department-submit)', function (obj) {
                                admin.req({
                                    url: true_url + '/departmentInformation/put'
                                    , method: 'put'
                                    , data: obj.field

                                    , success: function (res) {
                                        var meta = res['meta'];
                                        layer.msg(meta['msg']);
                                        layui.table.reload('department-information'); //重载表格
                                    }
                                    , error: function (res) {
                                        layer.msg('未知错误');

                                    }
                                });

                                layer.close(index); //执行关闭
                            });

                        });
                    }
                });
            }
        });


        var active = {
            add: function () {
                admin.popup({
                    title: '添加部门'
                    , area: ['420px', '450px']
                    , id: 'LAY-popup-department-add'
                    , success: function (layero, index) {
                        view(this.id).render('departments/add-department-form').done(function () {
                            //监听提交
                            form.on('submit(department-submit)', function (data) {

                                admin.req({
                                     method: 'post'
                                    ,url: true_url + '/departmentInformation/post'

                                    , data: data.field
                                    , success: function (res) {
                                        var meta = res['meta'];
                                        layer.msg(meta['msg']);
                                        layui.table.reload('department-information'); //重载表格
                                    }
                                    , error: function (res) {
                                        layer.msg('未知错误');

                                    }
                                });

                                layer.close(index); //执行关闭
                            });
                        });
                    }
                });

            }
            //批量删除
            , batchdel: function () {
                var checkStatus = table.checkStatus('department-information')
                    ,checkData = checkStatus.data; //得到选中的数据
                console.log(checkData);
                if(checkData.length === 0){
                    return layer.msg('请选择数据');
                }

                layer.msg('由于delete方法 中服务器无法获取data信息 此批量删除功能暂未实现，之后可以考虑使用post 方法包装delete');

               /* layer.alert('确认删除', {

                        btn: ['确认', '取消']
                        , btn1: function () {
                            admin.req({
                                data:{
                                    "departmentIds":checkData
                                }
                                ,method:'delete'
                                ,url: true_url + '/departmentInformation/deleteLots'
                                , success: function (res) {
                                    var meta = res['meta'];
                                    layer.msg(meta['msg']);
                                    layui.table.reload('department-information'); //重载表格
                                }
                                , error: function (res) {
                                    layer.msg('未知错误');

                                }

                            });

                        }
                        , btn2: function () {
                            layer.msg('已取消');
                        }
                    }
                );*/




            }

        };

        $('.layui-btn.department').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });

    });
</script>


